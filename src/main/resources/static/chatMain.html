<!DOCTYPE html>
<html lang="en" >

<head>
<meta charset="UTF-8">
<title>Direct Messaging</title>

<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" rel="stylesheet">

<meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="Cache" content="no-cache">
<link rel="stylesheet" href="css/reset.min.css">


<link rel="stylesheet" href="css/style.css">


</head>

<script src="js/jquery-1.11.1.min.js"></script>

<script>
    $.get("user/checklogin",
        function (data) {
            if (data.code==40000)
                window.location.href = "demo.html";
        });
    var websocket = null;
</script>
<body>
<div class="topnav">
    <a >Cayp聊天系统</a>
    <a>欢迎:</a>
    <a id="account">未登录</a>s
    <a id="name"></a>
    <a onclick=logout()>退出</a>
</div>
  <div class="wrapper">
    <div class="container">
        <div class="left">
            <div class="top">
                <input type="text" placeholder="Search" />
                <a href="javascript:;" class="search"></a>
            </div>
            <ul id="people" class="people" style="height:500px;overflow-y:scroll;">
                <li class="person" data-chat="person1">
                    <img src="images/timg.jpg" alt="" />
                    <span class="name">公共聊天室</span>
                    <span class="time" style="color: #ff0000"></span>
                    <span class="preview"></span>
                </li>

            </ul>
        </div>

        <div class="right1" >
            <div id="rightC" class="right" >
                <div class="top"><span>To: <span class="name">公共聊天室</span></span></div>
                <div id="person1" class="chat" data-chat="person1">
                    </div>
                </div>



            <div id="into" class="inTo">
                <input id="messageTxt" type="text"style="position: relative;left: 10%;width: 50%;height: 30px"/>
                <button onclick="sendMessageBySocket()" class="send" style="position:relative;left:25%;height: 30px;width: 50px;color: #00b0ff;text-decoration-color: #DCDEE0">发送</button>

            </div>
        </div>
    </div>

        </div>
        </div>





<script  src="js/index.js"></script>
<script type="text/javascript">
      initChat();
function logout() {
    $.get("user/logout"
        ,function (data) {
        if(data.code==20000){
            window.location.href = "demo.html"
        }
    })
}
      function initChat() {
          var isUser = document.getElementById("account").text;
          //判断当前浏览器是否支持WebSocket
          if ('WebSocket' in window) {
              var socketUrl = "ws://localhost:10000/webSocket/"+isUser;
              websocket = new WebSocket(socketUrl);

          } else {
              alert('Your browser Not support webSocket')
              return;
          }

          //连接发生错误的回调方法
          websocket.onerror = function () {
              alert("连接服务端失败!")
              window.location.href = "demo.html"

          };

          //连接成功建立的回调方法
          websocket.onopen = function (event) {

          };

          //接收到消息的回调方法
          websocket.onmessage = function (data) {
                 var dataz  = JSON.parse(data.data);

             if(dataz.type == 1){
                 var fromid = dataz.fromid;
                 var text = dataz.textone;
                 document.getElementById(""+fromid).innerHTML += "<div class=\"bubble you\">"+text+"</div>"

             }else{
                var name = dataz.name;
                var text = dataz.textone;
                if(name == document.getElementById("name").text){
                   return
                }

                 document.getElementById("person1").innerHTML += "<div class=\"bubble you\">"+name+"："+text+"</div>"

             }
          };

          //连接关闭的回调方法
          websocket.onclose = function () {
              document.getElementById('message').innerHTML += "连接关闭" + '<br/>';
              window.location.href = "demo.html"
              websocket.close();
          };

          //监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
          window.onbeforeunload = function () {
              websocket.close();

          };
          window.onbeforeunload = function(event) {
              websocket.onclose =function(){};
              websocket.close();
          }
      }

      function sendMessageBySocket() {
          var text = document.getElementById("messageTxt").value;
          var toid =  friends.list.querySelector(".active").getAttribute('data-chat');
          var fromid = document.getElementById("account").text;
          var name = document.getElementById("name").text;
          if(text==""){
              alert("输入框不能为空!")
              return
          }
          if(toid=="person1"){
              var json = "{\"type\":\""+2+"\",\"fromid\":\""+fromid+"\",\"toid\":\""+toid+"\",\"textone\":\""+text+"\",\"name\":\""+name+"\"}";
          }else{
              var json = "{\"type\":\""+1+"\",\"fromid\":\""+fromid+"\",\"toid\":\""+toid+"\",\"textone\":\""+text+"\"}";
          }

          document.getElementById(""+toid).innerHTML+="<div class=\"bubble me\">"+text+"</div>"

          websocket.send(json);
          $("#messageTxt").val("");

      }

  </script>
<script type="text/javascript">

</script>
</body>

</html>
